# AI Team Support – End-to-End Operational Flow

This guide walks through the complete lifecycle of how the platform ingests emails, extracts and manages tasks, interacts with Notion, handles user corrections, and exposes functionality through the authenticated API surface. Treat it as the authoritative source when you need to explain the system to a new teammate, an auditor, or another AI agent.

---

## 1. Triggering the Pipeline

- **Scheduled runner** – `check_gmail_enhanced.py` is the long-running entry point. Locally it is invoked manually; in production it is executed on Google Cloud Run and triggered by Cloud Scheduler every 5 minutes.
- **Environment bootstrap** – The runner loads `.env`, prints the target Gmail account, and calls `check_gmail_for_updates_enhanced()` in `src/utils/gmail_processor_enhanced.py`.
- **Retry posture** – The loop never exits unless interrupted; errors are logged and surfaced before exiting with non-zero status.

---

## 2. Gmail Intake & Classification (`src/utils/gmail_processor_enhanced.py`)

1. **Authentication** – Connects to Gmail via IMAP using `GMAIL_ADDRESS`, `GMAIL_APP_PASSWORD`, and server constants from `src/config/settings.py`.
2. **Email fetch** – Pulls unread messages, normalizes headers, decodes MIME parts, and performs lightweight text chunking to prepare for AI analysis.
3. **Plugin initialization** – Loads policy and automation plugins (`src/plugins/...`) via the shared `plugin_manager`. This enables context verification, guideline enforcement, and future extensibility.
4. **Routing** – Delegates each message to `EmailRouter` (`src/core/services/email_router.py`) which decides whether the message is:
   - A *new task email* (first touch from a user),
   - A *correction reply* (detected via correlation IDs / thread matching),
   - Or ignorable noise (alerts, marketing, etc.).
5. **Context persistence** – Pending context checks or verification conversations are stored in JSON (`pending_conversations.json`) so multi-email conversations survive restarts.

---

## 3. New Task Processing Path

When `EmailRouter` flags a message as “new tasks”:

1. **Task extraction** – `src/core/task_extractor.py` and `src/core/agents/task_extraction_agent.py` parse email text, call Gemini via the shared AI client, and emit normalized task dictionaries (title, status, priority, due date, metadata).
2. **Service pipeline** – `TaskProcessingAgent` orchestrates:
   - Deduplication and canonicalization,
   - Notion schema mapping via `NotionAgent`,
   - Category detection and enrichment using AI analyzers (`src/core/ai/analyzers.py`).
3. **Persistence** – `NotionAgent` and `UserTaskService` (both Notion SDK clients) create or update pages in the user’s task database (`NOTION_DATABASE_ID`), feedback DB, and user registry (`NOTION_USERS_DB_ID`).
4. **Coaching insights** – `src/core/ai/insights.get_coaching_insight()` generates follow-up suggestions or accountability notes that accompany the confirmation email.
5. **Email confirmation** – `send_confirmation_email_with_correction_support()` builds multi-part (plain + HTML) summaries including processed tasks, AI insights, open task snapshots (optional), and correction instructions. A unique correlation ID is either generated by `CorrectionService` or falls back to a random UUID.
6. **Archival (optional)** – If `EMAIL_ARCHIVE_ENABLED=True`, `EmailArchiveService` writes the raw email content and metadata to PostgreSQL for compliance/auditing. Otherwise the archive step is skipped gracefully.

---

## 4. Correction Logging Layer (`src/core/services/correction_service.py`)

- **Initialization** – `CorrectionService` requires `DATABASE_URL`. It sets up an SQLAlchemy engine with pool management, creates tables defined in `src/core/models/correction_models.py`, and performs health checks.
- **Logging** – When confirmations are sent, `create_correction_log()` records:
  - `correlation_id`,
  - `user_email`,
  - Task IDs included in the original message,
  - Email subject and timestamps.
- **Status tracking** – `update_correction_log_status()` transitions logs through `pending → completed/failed`. `log_correction_application()` records each individual task update, including before/after payloads and error messages.
- **Maintenance** – `cleanup_old_logs()` and `get_correction_stats()` provide retention and telemetry capabilities.
- **Security** – `_validate_sender()` ensures replies come from the same address the confirmation was sent to.

If the service cannot initialize (missing `DATABASE_URL` or connectivity issues), the Gmail processor continues operating but disables correction features, logging the degradation.

---

## 5. Correction Reply Flow

When a user replies to the confirmation email:

1. **Correlation** – The Gmail processor matches the message via `Ref:` tokens in the subject or by replying to the same thread. Extracted correlation IDs and task IDs are looked up in `CorrectionService`.
2. **Agent interpretation** – `CorrectionAgent` (`src/core/agents/correction_agent.py`) receives the raw reply text and the ordered list of original task IDs. It:
   - Builds a focused prompt with instructions, enumerated tasks, and examples.
   - Calls Gemini (`src/core.gemini_client.client`) for a JSON-formatted response.
   - Validates corrections (1-based indexing, allowed statuses, priorities, date formats).
   - Converts results to concrete task updates/deletes linked to task IDs.
3. **Task application** – `src/core/tasks/correction_tasks.process_correction` (Celery task) and `SecureCorrectionService`/`CachedCorrectionService` apply updates:
   - Fetch current task state from Notion,
   - Apply modifications (status, priority, due dates, deletes),
   - Record outcomes back in `CorrectionService`.
4. **Confirmation reply** – Once corrections succeed, the system sends an updated status email (via Gmail SMTP) to acknowledge the changes. Failures trigger retries and detailed logging.

---

## 6. API & Web Layer (`src/api/app_auth.py`)

The Flask app is a complement to the automation pipeline and exposes user-facing endpoints.

- **Startup** – Loads environment variables, installs required packages, initializes plugins, and validates Notion connectivity.
- **Authentication** – `AuthService` manages registration, login, password hashing, and JWT issuance (`src/core/security/jwt_utils.py`). Roles and guards (`require_auth`, `require_role`) protect routes.
- **Task management** – Exposes endpoints for CRUD operations on tasks, fetching coaching insights, reviewing corrections, and managing user-specific Notion databases.
- **Admin tooling** – Provides dashboards for system health, metrics, and manual overrides (e.g., reprocessing or forcing reminders).
- **Shared services** – Reuses the same service layer (`UserTaskService`, analyzers, Notion wrappers) as the automation pipeline, ensuring consistent business logic.

---

## 7. Background Jobs & Scheduling

- **Celery** – Configured in `src/core/services/celery_config.py` with Redis or Memorystore as the broker. Handles:
  - Correction processing (`process_correction`),
  - Reminder emails,
  - Verification follow-ups (from the plugin system),
  - Periodic cleanup jobs (correction logs, archives).
- **Celery Beat** – Optional scheduler (`celerybeat-schedule`) keeps recurring jobs in sync with production SLAs.
- **Metrics** – `correction_metrics.py` and related services capture durations, success rates, and surfaces them through logs or optional dashboards.

---

## 8. External Integrations & Data Stores

| Integration | Purpose | Key Files / Services |
|-------------|---------|----------------------|
| Gmail (IMAP/SMTP) | Email ingestion & outbound confirmations | `gmail_processor_enhanced.py`, `check_gmail_enhanced.py` |
| Google Gemini | AI task extraction, coaching insights, correction interpretation | `src/core/gemini_client.py`, AI agent modules |
| Notion | Source of truth for tasks, feedback, user profiles | `NotionAgent`, `UserTaskService`, `NotionService` |
| PostgreSQL | Correction logs, optional email archive | `CorrectionService`, `EmailArchiveService` |
| Redis/Memorystore | Celery broker, caching | `celery_config.py`, `cached_correction_service.py` |

---

## 9. Deployment & Operations

- **Cloud Run Containers** – Separate images for the Gmail processor and API (`deployment/Dockerfile.gmail-processor`, `Dockerfile`).
- **Cloud Scheduler** – Invokes the Gmail processor endpoint every five minutes; environment variables are managed through Google Secret Manager.
- **Logging & Monitoring** – GCP logging captures stdout/stderr; instructions for log tailing live in `docs/GOOGLE_CLOUD_DEPLOYMENT.md`.
- **Disaster Recovery** – Email archive and correction database provide replay capabilities; Notion remains the canonical data store.
- **Environment Parity** – Local development uses `.env` files; staging and production rely on separate config bundles referenced in `docs/DOCKER_ENVIRONMENT_SETUP.md`.

---

## 10. Failure Handling & Observability

- **Graceful degradation** – If Notion or the correction database is unavailable, the processor logs warnings, skips dependent features, and continues processing other emails.
- **Retries** – Database operations are wrapped with exponential backoff; Celery tasks leverage built-in retry policies.
- **Alerts** – Failures in the Gmail loop print stack traces and exit (so Cloud Run restarts the container). Metrics services facilitate future alert integrations (e.g., Prometheus).
- **Auditability** – Every correction is stored with before/after data, enabling forensic analysis. Plugins can enforce extra compliance rules (e.g., checklists, approvals).

---

## 11. How to Walk Through the Flow Yourself

1. **Local API** – `python -m src.api.app_auth` spins up the authenticated API. Use it to register users, confirm Notion connectivity, and inspect task data.
2. **Simulated ingestion** – `python check_gmail_enhanced.py` runs the Gmail processor against your configured inbox. Send yourself a test email, watch tasks appear in Notion, and review the confirmation email.
3. **Correction test** – Reply to the confirmation with phrases like “Change task 1 status to completed.” Observe the correction log entries (`CorrectionService`), Notion updates, and the follow-up email.
4. **Monitor logs** – Tail Cloud Run logs in production or inspect console output locally to verify each stage’s health.

---

## 12. Reference Documents

- `README.md` – High-level overview and quickstart.
- `PROJECT_STRUCTURE.md` – Detailed code organization.
- `DEPLOYMENT_READY_SUMMARY.md` – Production readiness checklist and architecture synopsis.
- `docs/GOOGLE_CLOUD_DEPLOYMENT.md` – Infrastructure setup.
- `docs/testing/TESTING_GUIDE.md` – Testing strategies and commands.

With this operational map, you can confidently explain the system end-to-end, trace issues across services, and onboard new contributors or automation agents without missing critical context.

